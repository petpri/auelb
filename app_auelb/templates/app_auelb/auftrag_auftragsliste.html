{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load django_bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}

{% block header %}
<nav class="navbar navbar-expand-sm bg-dark navbar-dark fixed-top w-100">
    <div class="container-fluid px-2 d-flex align-items-center justify-content-between">
        
        <!-- Suchformular -->
        <form method="get" class="d-flex w-75 align-items-center">
            <input name="searchsuche" class="form-control me-2" type="search" placeholder="Kundenauf. enthÃ¤lt" value="{{ request.GET.searchsuche }}">
            <input name="materialsuche" class="form-control me-2" type="search" placeholder="Materialnr. enthÃ¤lt" value="{{ request.GET.materialsuche }}">
            <input name="kundennummer" class="form-control me-2" type="search" placeholder="Kundennr. enthÃ¤lt" value="{{ request.GET.kundennummer }}">
            <input name="fertigungsauftrag" class="form-control me-2" type="search" placeholder="Fertigungsauf. enthÃ¤lt" value="{{ request.GET.fertigungsauftrag }}">
            <select name="my_select" class="form-select me-2">
                <option value="1">-- Alle --</option>
                {% for status in data %}
                    <option value="{{ status.id }}" {% if request.GET.my_select == status.id|stringformat:"s" %}selected{% endif %}>
                        {{ status.kd_auswahl }}
                    </option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-outline-success btn-sm me-2">Search</button>

            <!-- Archiv/Produktiv Button -->
            <a href="{% url 'auftragsliste_geliefert' %}?{{ request.GET.urlencode }}" class="btn btn-outline-success btn-sm me-2">ARCHIV</a>
            <a href="{% url 'create_kundenauftrag' %}" class="btn btn-outline-success btn-sm me-2">NEU</a>
        </form>

        <!-- Anzeige angemeldeter Benutzer -->
        <div class="d-flex align-items-center text-light">
            {% if user.is_authenticated %}
                <span class="me-3">Angemeldet als: <strong>{{ user.username }}</strong></span>
                <a href="{% url 'login' %}" class="btn btn-outline-light btn-sm">Abmelden</a>
            {% else %}
                <a href="{% url 'login' %}" class="btn btn-outline-light btn-sm">Anmelden</a>
            {% endif %}
        </div>
    </div>

    <div class="text-danger px-2" style="font-weight: normal;">{{ mode_label }}</div>
</nav>
{% endblock %}

{% block content %}
<div class="table-responsive px-2">
    <table class="table table-bordered table-sm align-middle text-nowrap fs-7 m-0 w-100">
        <thead class="thead-dark sticky-top">
            <tr class="table-danger">
                <th>A</th>
                <th>P</th>
                <th>K</th>
                <th>M</th>
                <th>U</th>
                <th>KD-Auftrag</th>
                <th>KD-Nummer</th>
                <th>FERT/BANF</th>
                <th>Material</th>
                <th>Bez./KD-Name</th>
                <th>bestellt</th>
                <th>Endtermin</th>
                <th>SAF</th>
                <th>STATUS</th>
                <th>INFO</th>
            </tr>
        </thead>
        <tbody>
            {% for z in ihre_daten.all %}
            <tr class="table-ka py-1">
                <td><a href="{% url 'kundenauftrag_bearbeiten' z.pk %}?from={{ current_view }}&{{ query_string }}">ğŸ’¼</a></td>
                <td><a href="{% url 'kundenauftrag_update' z.pk %}?from={{ from_param }}&{{ query_string }}">ğŸ­</a></td>
                <td></td>
                <td></td>
                <td>{{ z.id }}{{z.instance.id}}</td>
                <td>{{ z.kundenauftrag|default:"" }}</td>
                <td>{{ z.kundenname.kundennummer|default:"" }}</td>
                <td></td>
                <td></td>
                <td>{{ z.kundenname.kundenname|default:"" }}</td>
                <td></td>
                <td>{{ z.v_endtermin|date:"d.m.Y" }}</td>
                <td></td>
                <td>{{ z.statuskundenauftrag }}</td>
                <td title="{{ z.kun_infofeld|default_if_none:'' }}">{{ z.kun_infofeld|default_if_none:''|truncatechars:20 }}</td>
            </tr>

            {% for y in z.order_back_1.all %}
                {% if y.bezeichnung and y.bezeichnung.materialnummer %}
                <tr class="table-prod">
                    <td></td><td></td>
                    <td><a href="{% url 'produkt_update' y.pk %}?from={{ from_param }}&{{ request.GET.urlencode }}">ğŸ§©</a></td>
                    <td><a href="{% url 'merkmale_bearbeiten' y.bezeichnung.pk %}?from={{ current_view }}&{{ request.GET.urlencode }}">âš™ï¸</a></td>
                    <td><a href="{% url 'urblatt_bearbeiten' y.bezeichnung.pk %}?from={{ current_view }}&{{ request.GET.urlencode }}">ğŸ•–</a></td>
                    <td></td><td></td>
                    <td>{{ y.p_fertigungsauftrag|default:"" }}</td>
                    <td>{{ y.bezeichnung.materialnummer }}</td>
                    <td>{{ y.bezeichnung.bezeichnung }}</td>
                    <td>{{ y.p_auftragsmenge|default:"" }}</td>
                    <td>{{ y.p_endtermin|date:"d.m.Y" }}</td>
                    <td>{{ y.p_serviceanfrage|default:"" }}</td>
                    <td>{{ y.statusprodukt }}</td>
                    <td title="{{ y.p_infofeld|default_if_none:'' }}">{{ y.p_infofeld|default_if_none:''|truncatechars:20 }}</td>
                </tr>

                {% for x in y.order_back_2.all %}
                    {% if x.bezeichnung and x.bezeichnung.materialnummer %}
                    <tr class="table-komp">
                        <td></td><td></td><td></td>
                        <td><a href="{% url 'merkmale_bearbeiten' x.bezeichnung.pk %}?from={{ current_view }}&{{ request.GET.urlencode }}">âš™ï¸</a></td>
                        <td><a href="{% url 'urblatt_bearbeiten' x.bezeichnung.pk %}?from={{ current_view }}&{{ request.GET.urlencode }}">ğŸ•–</a></td>
                        <td></td><td></td>
                        <td>{{ x.k_fertigungsauftrag|default:"" }}</td>
                        <td>{{ x.bezeichnung.materialnummer }}</td>
                        <td>{{ x.bezeichnung.bezeichnung }}</td>
                        <td>{{ x.k_auftragsmenge|default:"" }}</td>
                        <td>{{ x.k_endtermin|date:"d.m.Y" }}</td>
                        <td>{{ x.k_serviceanfrage|default:"" }}</td>
                        <td>{{ x.statuskomponente }}</td>
                        <td title="{{x.k_infofeld|default_if_none:''}}">{{x.k_infofeld|default_if_none:''|truncatechars:20}}</td>
                    </tr>
                    {% endif %}
                {% endfor %}
                {% endif %}
            {% endfor %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
